{% extends "base.html" %}
{% load static %}

{% block title %}Tenant Documents{% endblock %}
{% block page_title %}{{ tenant.name }} <span>-{{ tenant.tenant_type_fk }}</span>{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tenant_detail1.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
/* Buttons */
.email-button {
    background-color: #041c31;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
}
.email-button:hover {
    background-color: #063d63;
}
.delete-button {
    background-color: #dc3545;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
}
.delete-button:hover {
    background-color: #b02a37;
}
.print-button, .print-button1 {
    background-color: #198754;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
}
.print-button:hover, .print-button1:hover {
    background-color: #146c43;
}
.upload-button {
    background-color: #0d6efd;
    color: white;
    padding: 6px 12px;
    border-radius: 4px;
    text-decoration: none;
}
.upload-button:hover {
    background-color: #0b5ed7;
}

/* Modal content padding fix */
.modal-body {
    max-height: 70vh;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block content %}
<div class="tenant-update-row" style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; font-size: 0.85rem;">

    <!-- Email (still separate) -->
    <form method="POST" action="{% url 'update_tenant_email' tenant.id %}" 
          style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem;">
        {% csrf_token %}
        <label for="email" style="font-weight: bold; font-size: 0.85rem;">Email:</label>
        <input type="email" name="email" id="email" value="{{ tenant.email }}" 
               style="padding: 4px; border: 1px solid #ccc; border-radius: 4px; width: 180px; font-size: 0.85rem;" 
               placeholder="Enter tenant email" />
{% if perms.files.change_tenant %}
<button type="submit" style="padding: 4px 6px; background-color: #041c31; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
    <i class="bi bi-pencil-fill"></i> Update
</button>
{% endif %}

    </form>

    <!-- Combined Commencement + Escalation Form -->
    <form method="POST" action="{% url 'update_tenant_date_rate' tenant.id %}" 
          style="display: flex; align-items: center; gap: 10px; font-size: 0.85rem;">
        {% csrf_token %}

        <!-- Commencement Date -->
        <label for="commencement_date" style="font-weight: bold; font-size: 0.85rem;">Rent Commencement:</label>
        <input type="date" name="commencement_date" id="commencement_date" 
               value="{{ tenant.commencement_date|date:'Y-m-d' }}" 
               style="padding: 4px; border: 1px solid #ccc; border-radius: 4px; width: 140px; font-size: 0.85rem;" />

        <!-- Escalation Rate -->
        <label for="escalation_rate" style="font-weight: bold; font-size: 0.85rem;">Rent Escalation %:</label>
        <input type="number" name="escalation_rate" id="escalation_rate" 
               value="{{ tenant.escalation_rate }}" step="0.01" min="0"
               style="padding: 3px; border: 1px solid #ccc; border-radius: 4px; width: 80px; font-size: 0.85rem;" 
               placeholder="5.00" />

        <!-- Submit Button -->
         {% if perms.files.change_tenant %}<button type="submit" style="padding: 4px 8px; background-color: #041c31; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
           <i class="bi bi-check-circle-fill"></i> Update Both
        </button>{% endif %}
    </form>

</div>



</div>
<div class="container"> 

    <!-- Tenant Units Section -->
    <h5 class="mb-3" >Unit(s)</h5>

    <div class="d-flex flex-wrap gap-3">

        <!-- Box 1: Total Size + Add Unit -->
        <div class="card flex-fill" style="min-width: 250px; max-width: 350px;">
            <div class="card-body text-center">
                <p class="mb-3"><strong>Total Size:</strong> {{ tenant.total_size_sqm }} m² / {{ tenant.total_size_sqft }} ft²</p>
                
                {% if perms.files.add_unit %}
                <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#addUnitModal">
                    <i class="bi bi-plus-lg"></i> Add New Unit
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Box 2: Show Units + Units Table -->
        <div class="card flex-fill" style="min-width: 350px; max-width: 700px;">
            <div class="card-body">
                <button id="toggleUnitsBtn" class="btn btn-info w-100 mb-3" type="button">Show Units</button>

                <div id="unitsTable" class="d-none">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-bordered table-striped table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Unit ID</th>
                                    <th>Size</th>
                                    <th>Size Type</th>
                                    {% if perms.files.change_unit or perms.files.delete_unit %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for unit in tenant.units.all %}
                                <tr>
                                    <td>{{ unit.unit_id }}</td>
                                    <td>{{ unit.size_sqm|floatformat:2 }}</td>
                                    <td>sqm</td>
                                    {% if perms.files.change_unit or perms.files.delete_unit %}
                                    <td class="d-flex gap-1">
                                        {% if perms.files.change_unit %}
                                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editUnitModal{{ unit.id }}">Edit</button>
                                        {% endif %}

                                        {% if perms.files.delete_unit %}
                                        <form method="POST" action="{% url 'delete_unit' unit.id %}" style="display:inline;" onsubmit="return confirmDelete();">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                </tr>

                                <!-- Edit Unit Modal -->
                                {% if perms.files.change_unit %}
                                <div class="modal fade" id="editUnitModal{{ unit.id }}" tabindex="-1" aria-labelledby="editUnitModalLabel{{ unit.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <form method="POST" action="{% url 'update_unit' unit.id %}">
                                                {% csrf_token %}
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editUnitModalLabel{{ unit.id }}">Edit Unit {{ unit.unit_id }}</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="unit_id{{ unit.id }}" class="form-label">Unit Name</label>
                                                        <input type="text" name="unit_id" id="unit_id{{ unit.id }}" class="form-control" value="{{ unit.unit_id }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="size{{ unit.id }}" class="form-label">Size</label>
                                                        <input type="number" step="0.01" name="size" id="size{{ unit.id }}" class="form-control" value="{{ unit.size_sqm }}" required>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="unit_type{{ unit.id }}" class="form-label">Size Type</label>
                                                        <select name="unit_type" id="unit_type{{ unit.id }}" class="form-select">
                                                            <option value="sqm" {% if unit.size_sqm %}selected{% endif %}>Square Metres (sqm)</option>
                                                            <option value="sqft" {% if unit.size_sqft and not unit.size_sqm %}selected{% endif %}>Square Feet (sqft)</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- End flex row -->
</div>


    <!-- Add Unit Modal -->
    <div class="modal fade" id="addUnitModal" tabindex="-1" aria-labelledby="addUnitModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" action="{% url 'add_unit' tenant.id %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="addUnitModalLabel">Add New Unit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="unit_id" class="form-label">Unit Name</label>
                            <input type="text" name="unit_id" id="unit_id" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="size" class="form-label">Size</label>
                            <input type="number" step="0.01" name="size" id="size" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="unit_type" class="form-label">Unit Size Type</label>
                            <select name="unit_type" id="unit_type" class="form-select">
                                <option value="sqm">Square Metres (sqm)</option>
                                <option value="sqft">Square Feet (sqft)</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Add Unit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

<!-- JS: Toggle Units Table -->
<script>
    const toggleBtn = document.getElementById('toggleUnitsBtn');
    const unitsTable = document.getElementById('unitsTable');

    toggleBtn.addEventListener('click', () => {
        if (unitsTable.classList.contains('d-none')) {
            unitsTable.classList.remove('d-none');
            toggleBtn.textContent = 'Hide Units';
        } else {
            unitsTable.classList.add('d-none');
            toggleBtn.textContent = 'Show Units';
        }
    });



    function confirmDelete() {
        return confirm("Are you sure you want to delete this unit? This action cannot be undone.");
    }
</script>





<div class="container">

    <!-- Flash Messages -->
    {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for message in messages %}
                <div style="padding: 10px; border-radius: 5px; margin-bottom: 10px;
                            {% if message.tags == 'error' %}background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
                            {% elif message.tags == 'success' %}background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;
                            {% else %}background-color: #cce5ff; color: #004085; border: 1px solid #b8daff;
                            {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Actions -->
    <div class="actions" style="margin-bottom: 15px;">
        {% if perms.files.delete_tenant %}
        <form method="POST" action="{% url 'delete_tenant' tenant.id %}" 
              onsubmit="return confirm('Are you sure you want to delete this tenant? All associated documents will also be deleted.')" 
              style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="delete-button">
                <i class="bi bi-trash-fill"></i> Delete Tenant
            </button>
        </form>
        {% endif %}

       {% if perms.files.view_document %}
<button onclick="printAllDocuments()" class="print-button">
    <i class="bi bi-printer-fill"></i> Print All Documents
</button>
{% endif %}


        {% if perms.files.add_document %}
        <a href="{% url 'upload_documents_by_type' %}?tenant_id={{ tenant.id }}" class="upload-button">
            <i class="bi bi-cloud-upload-fill"></i> Upload More Documents
        </a>
        {% endif %}

        <!-- Send Reminder Button (opens modal) -->
       {% if perms.files.add_emailreminderlog %}
<button type="button" class="email-button" data-bs-toggle="modal" data-bs-target="#reminderModal">
    <i class="bi bi-send-fill"></i> Send Reminder
</button>
{% endif %}


       {% if perms.files.add_emailreminderlog  %}
<button type="button" class="email-button" data-bs-toggle="modal" data-bs-target="#shareModal">
    <i class="bi bi-share-fill"></i> Share Documents
</button>
{% endif %}

    </div>

    <!-- Documents Table -->
    <!-- Documents Table -->
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Type</th>
                <th>File</th>
                <th>Upload Date</th>
                <th>Commencement</th> <!-- NEW -->
                <th>Expiry</th>       <!-- UPDATED -->
                <th>Status</th>
               {% if perms.files.view_document %}<th>Print</th>{% endif %}

                  {% if perms.files.view_document %}<th>Download</th>{% endif %}
                  {% if perms.files.add_archiveddocument %}<th>Archive</th>
                {% endif %}
                {% if perms.files.delete_document %}<th>Delete</th>{% endif %}
               

            </tr>
        </thead>
<tbody>
    {% for item in documents %}
    <tr id="doc-row-{{ item.document.id }}">
        <td>{{ item.document.doc_type_fk.label|default:"Unknown" }}</td>
        <td>
            {% if item.file_type == "pdf" or item.file_type in "jpg jpeg png" %}
                <a href="{{ item.display_path }}" target="_blank" rel="noopener" class="doc-link">
                    {% if item.file_type == "pdf" %}
                        <i class="bi bi-file-earmark-pdf-fill"></i> View PDF
                    {% else %}
                        <i class="bi bi-image-fill"></i> View Image
                    {% endif %}
                </a>
            {% elif item.file_type in "doc docx" %}
                <a href="{{ item.display_path }}" download class="doc-link">
                    <i class="bi bi-file-earmark-word-fill"></i> Download Word Document
                </a>
            {% else %}
                <a href="{{ item.display_path }}" download class="doc-link">
                    <i class="bi bi-paperclip"></i> Download {{ item.file_type|upper }}
                </a>
            {% endif %}
        </td>
        <td>{{ item.document.upload_date|date:"Y-m-d" }}</td>

        <!-- Commencement & Expiry -->
        <td>
            <form method="POST" class="inline-form" id="doc-form-{{ item.document.id }}" style="display:flex; align-items:center; gap:3px;">
                {% csrf_token %}
                <input type="date" name="commencement_date" value="{{ item.document.commencement_date|date:'Y-m-d' }}" 
                       class="commencement-input" data-doc-id="{{ item.document.id }}" style="flex:1; height:30px; padding:2px 5px;">
               {% if perms.files.change_document %}
               <button type="button" class="confirm-btn" data-doc-id="{{ item.document.id }}" 
                       style="background-color:#198754; color:white; border:none; border-radius:4px; padding:2px 6px; cursor:pointer; height:30px; display:flex; align-items:center; gap:5px;">
                    {% if perms.files.change_document %}<span class="btn-text">✓</span>{% endif %}
                    <span class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
                </button>
               {% endif %}
            </form>
        </td>

        <td id="expiry-{{ item.document.id }}">
          {% if item.document.expiry_date %}
            {{ item.document.expiry_date|date:"d/m/Y" }}
          {% else %}
            Not set
          {% endif %}
        </td>

        <td>
            {% if item.document.is_expired %}
                <span class="status-expired">Expired</span>
            {% else %}
                <span class="status-valid">Valid</span>
            {% endif %}
        </td>

        <!-- Print button -->
        {% if perms.files.view_document %}
        <td>
            <button onclick="printSingleDocument({{ item.document.id }})" class="print-button1">
                <i class="bi bi-printer-fill"></i> Print
            </button>
        </td>
        {% endif %}

        <!-- Download button -->
        {% if perms.files.view_document %}
        <td>
            <a href="{% url 'download_document' item.document.id %}" class="btn btn-sm btn-success">
                <i class="bi bi-download"></i> Download
            </a>
        </td>
        {% endif %}

        <!-- Archive button -->
      {% if perms.files.add_archiveddocument %}
<td>
    <form method="POST" action="{% url 'archive_document' item.document.id %}" 
          onsubmit="return confirm('Are you sure you want to archive this document?')">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-warning">
            <i class="bi bi-archive-fill"></i> Archive
        </button>
    </form>
</td>
{% endif %}


        <!-- Delete button -->
        {% if perms.files.delete_document %}
        <td>
            <form method="POST" action="{% url 'delete_document' item.document.id %}" onsubmit="return confirm('Delete this document?')">
                {% csrf_token %}
                <button type="submit" class="delete-button">
                    <i class="bi bi-trash-fill"></i> Delete
                </button>
            </form>
        </td>
        {% endif %}
    </tr>
    {% empty %}
    <tr><td colspan="9" class="no-docs">No documents found.</td></tr>
    {% endfor %}
</tbody>


    </table>
</div>




 <!-- Email Reminder Modal -->
<div class="modal fade" id="reminderModal" tabindex="-1" aria-labelledby="reminderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" action="{% url 'send_email_reminder' tenant.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="reminderModalLabel">Send Document Reminder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="subject" class="form-label">Subject</label>
            <input type="text" name="subject" id="subject" class="form-control" value="Document Submission Reminder" required>
          </div>
          <div class="mb-3">
            <label for="cc_emails" class="form-label">CC Emails (comma separated)</label>
            <input type="text" name="cc_emails" id="cc_emails" class="form-control" placeholder="e.g. cc1@example.com, cc2@example.com">
          </div>

          <div class="mb-3">
            <label for="message" class="form-label">Message</label>
            <textarea name="message" id="message" class="form-control" rows="8">
Dear {{ tenant.name }},

Please submit or renew the following documents:

Thank you,
Management
            </textarea>
          </div>

          <div class="mb-3">
            <label class="form-label"><strong>Select Documents to Remind About:</strong></label>
            <div>
              <button type="button" id="selectAllBtn" class="btn btn-sm btn-outline-primary mb-2">Select All</button>
              <button type="button" id="unselectAllBtn" class="btn btn-sm btn-outline-secondary mb-2">Unselect All</button>
            </div>
            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
              {% for doc_type in all_doc_types %}
                <div class="form-check">
                  <input class="form-check-input doc-type-checkbox" type="checkbox" name="doc_types" value="{{ doc_type.id }}" id="doc_type_{{ doc_type.id }}">
                  <label class="form-check-label" for="doc_type_{{ doc_type.id }}">{{ doc_type.label }}</label>
                </div>
              {% empty %}
                <p>No document types found.</p>
              {% endfor %}
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="sendEmailBtn" type="submit" class="btn btn-primary">
            <span class="btn-text">Send Email</span>
            <span class="spinner-border spinner-border-sm ms-2" role="status" style="display:none;"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
    

    <!-- Share Documents Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" action="{% url 'share_documents' tenant.id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="shareModalLabel">Share Documents</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="receiver_email" class="form-label">Receiver Email</label>
            <input type="email" name="receiver_email" id="receiver_email" class="form-control" required placeholder="Enter recipient email">
          </div>

          <div class="mb-3">
            <label for="cc_emails_share" class="form-label">CC Emails (comma separated)</label>
            <input type="text" name="cc_emails_share" id="cc_emails_share" class="form-control" placeholder="e.g. cc1@example.com, cc2@example.com">
          </div>

          <div class="mb-3">
            <label for="message_share" class="form-label">Message</label>
            <textarea name="message_share" id="message_share" class="form-control" rows="6">Please find attached the requested documents.</textarea>
          </div>

          <div class="mb-3">
            <label class="form-label"><strong>Select Documents to Share:</strong></label>
            <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
              {% for item in documents %}
                <div class="form-check">
                  <input class="form-check-input share-doc-checkbox" type="checkbox" name="share_docs" value="{{ item.document.id }}" id="share_doc_{{ item.document.id }}">
                  <label class="form-check-label" for="share_doc_{{ item.document.id }}">{{ item.document.doc_type_fk.label }} - {{ item.document.file.name }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="shareDocsBtn" type="submit" class="btn btn-primary">
            <span class="btn-text">Share</span>
            <span class="spinner-border spinner-border-sm ms-2" role="status" style="display:none;"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


    
    <!-- Email Reminder Modal -->
    {# ... Your email modal code unchanged ... #}

    <!-- Share Documents Modal -->
    {# ... Your share modal code unchanged ... #}

    <!-- JS for Printing -->
    <script>
/* -------------------------
   Global Function Definitions
------------------------- */
function printSingleDocument(docId) {
    const row = document.getElementById(`doc-row-${docId}`);
    const link = row.querySelector('.doc-link');
    if (!link) return alert('Document not found.');
    const docUrl = link.href;
    const ext = docUrl.split('.').pop().toLowerCase();

    if (['pdf', 'jpg', 'jpeg', 'png'].includes(ext)) {
        const printWindow = window.open(docUrl, '_blank');
        if (printWindow) {
            printWindow.focus();
            printWindow.print();
        } else {
            alert('Popup blocked. Please allow popups for this site.');
        }
    } else if (['doc', 'docx'].includes(ext)) {
        const a = document.createElement('a');
        a.href = docUrl;
        a.download = docUrl.split('/').pop();
        document.body.appendChild(a);
        a.click();
        a.remove();
        alert('Word document downloaded. Open and print manually.');
    } else {
        alert("This file type can't be printed directly.");
    }
}
window.printSingleDocument = printSingleDocument; // attach globally

function printAllDocuments() {
    const links = document.querySelectorAll('.doc-link');
    const supported = ['pdf', 'jpg', 'jpeg', 'png'];
    let index = 0;

    function printNext() {
        if (index >= links.length) return;
        const link = links[index];
        const docUrl = link.href;
        const ext = docUrl.split('.').pop().toLowerCase();

        if (supported.includes(ext)) {
            const win = window.open(docUrl, '_blank');
            win.onload = () => {
                win.focus();
                win.print();
                setTimeout(() => { win.close(); index++; printNext(); }, 1000);
            };
        } else { 
            index++; 
            printNext(); 
        }
    }
    printNext();
}
window.printAllDocuments = printAllDocuments;

/* -------------------------
   DOM Ready Event
------------------------- */
document.addEventListener('DOMContentLoaded', function () {
    // Commencement date confirm buttons
    const confirmButtons = document.querySelectorAll('.confirm-btn');
    confirmButtons.forEach(button => {
        button.addEventListener('click', function () {
            const docId = this.dataset.docId;
            const input = document.querySelector(`.commencement-input[data-doc-id="${docId}"]`);
            const commencementDate = input.value;
            const csrfToken = document.querySelector(`#doc-form-${docId} input[name="csrfmiddlewaretoken"]`).value;

            const btnText = this.querySelector('.btn-text');
            const spinner = this.querySelector('.spinner-border');

            btnText.textContent = 'Saving...';
            spinner.style.display = 'inline-block';
            this.disabled = true;

            fetch('/update-commencement-date/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `doc_id=${docId}&commencement=${commencementDate}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.expiry_date) {
                    document.getElementById(`expiry-${docId}`).innerText = data.expiry_date;
                    input.style.borderColor = '#198754';
                    setTimeout(() => input.style.borderColor = '', 1000);
                }
            })
            .catch(err => console.error('Error updating commencement date:', err))
            .finally(() => {
                btnText.textContent = '✓';
                spinner.style.display = 'none';
                this.disabled = false;
            });
        });
    });

    // Send Email Reminder Button
    const sendEmailForm = document.querySelector('#reminderModal form');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const sendBtnText = sendEmailBtn?.querySelector('.btn-text');
    const sendSpinner = sendEmailBtn?.querySelector('.spinner-border');

    sendEmailForm?.addEventListener('submit', function () {
        sendBtnText.textContent = 'Sending...';
        sendSpinner.style.display = 'inline-block';
        sendEmailBtn.disabled = true;
    });

    // Select / Unselect all checkboxes in Reminder Modal
    const selectAllBtn = document.getElementById('selectAllBtn');
    const unselectAllBtn = document.getElementById('unselectAllBtn');
    const checkboxes = document.querySelectorAll('.doc-type-checkbox');

    selectAllBtn?.addEventListener('click', () => checkboxes.forEach(cb => cb.checked = true));
    unselectAllBtn?.addEventListener('click', () => checkboxes.forEach(cb => cb.checked = false));

    // Auto-update message textarea based on selected documents
    const messageTextarea = document.getElementById('message');
    function updateMessage() {
        const selectedDocs = Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.nextElementSibling.textContent.trim());

        if (selectedDocs.length > 0) {
            const baseMessage = `Dear {{ tenant.name }},\n\nPlease submit or renew the following documents:\n${selectedDocs.join(', ')}\n\nThank you,\nManagement\n\n`;
            messageTextarea.value = baseMessage;
        } else {
            messageTextarea.value = `Dear {{ tenant.name }},\n\nPlease submit or renew the following documents:\n\nThank you,\nManagement`;
        }
    }

    checkboxes.forEach(cb => cb.addEventListener('change', updateMessage));
    selectAllBtn?.addEventListener('click', updateMessage);
    unselectAllBtn?.addEventListener('click', updateMessage);
});
</script>

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
